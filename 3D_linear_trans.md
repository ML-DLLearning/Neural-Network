# 对3D线性变换的学习——以最基础的3D-Haar为例
对于线性变换来讲最重要的其实是变换核，这应该也是算法更新的最有效的突破口
## Haar矩阵
$$
H_4 = \dfrac{1}{2}
\begin{bmatrix}
1 & 1 & 1 & 1 \\
1 & 1 & -1 & -1 \\
\sqrt{2} & -\sqrt{2} & 0 & 0 \\
0 & 0 & \sqrt{2} & -\sqrt{2}
\end{bmatrix}
$$
## 实例
### 输入矩阵为：
$$
X =
\begin{bmatrix}
1 & 2 & 3 & 4 \\
5 & 6 & 7 & 8 \\
9 & 10 & 11 & 12 \\
13 & 14 & 15 & 16 \\
\end{bmatrix}
$$
### 对每一列做Haar变换
$X：Y=H_4X$  
第一列：
$$
Y_1 =
\begin{bmatrix}14\\
-8\\
-2\sqrt{2}\\
-2\sqrt{2}
\end{bmatrix}
$$  
第二列：$$Y_2 =
\begin{bmatrix}
16 \\
-8 \\
-2\sqrt{2} \\
-2\sqrt{2}
\end{bmatrix}
$$  
第三列：$$
Y_3 =
\begin{bmatrix}
18 \\
-8 \\
-2\sqrt{2} \\
-2\sqrt{2}
\end{bmatrix}
$$  
第四列：$$
Y_4 =
\begin{bmatrix}
20 \\
-8 \\
-2\sqrt{2} \\
-2\sqrt{2}
\end{bmatrix}
$$  
最终结果：
$$
Y =
\begin{bmatrix}
14 & 16 & 18 & 20 \\
-8 & -8 & -8 & -8 \\
-2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2} \\
-2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2}
\end{bmatrix}
$$
### 再对每一行做线性变换
$Z = YH_4$
第一行：$
\begin{bmatrix}
34 &-4 &-\sqrt{2} & -\sqrt{2}
\end{bmatrix}
$
第二行：$
\begin{bmatrix}
-16 &0 &0 &0
\end{bmatrix}
$
第三行：$
\begin{bmatrix}
-4\sqrt{2} &0 &0 &0
\end{bmatrix}
$
第四行：$
\begin{bmatrix}
-4\sqrt{2} & 0 & 0 & 0
\end{bmatrix}
$
### 最终结果：
$$Z =
\begin{bmatrix}
34 & -4 & -\sqrt{2} & -\sqrt{2} \\
-16 & 0 & 0 & 0 \\
-4\sqrt{2} & 0 & 0 & 0 \\
-4\sqrt{2} & 0 & 0 & 0
\end{bmatrix}
$$
## 分析（浅层理解）
从上面的结果可以看出输入矩阵的能量被大大压缩，实现了信号的稀疏表示
### Haar矩阵的分析
#### Haar矩阵的原皮
$$
\begin{bmatrix}
1 & 1 & 1 & 1 \\
1 & 1 & -1 & -1 \\
\sqrt{2} & -\sqrt{2} & 0 & 0 \\
0 & 0 & \sqrt{2} & -\sqrt{2}
\end{bmatrix}
$$
进行归一化处理，每一个行的长度都是2，故在矩阵之前乘以一个$\dfrac{1}{2}$
#### 每行的作用
第一行用于求平均值（并不是算术平均，而是因为 Haar 正交矩阵要求每行的欧氏长度为 1（单位向量），所以系数是$\dfrac{1}{2}=\dfrac{1}{\sqrt{1^{2}+1^{2}+1^{2}+1^{2} } }$不是为了算术平均，而是为了正交规范化）（并不是很懂）
第二行计算前半段均值与后半段均值的差
第三行计算第一段内部变化，反映第一个半区的细节
第四行计算第二段内部变化，反映第二个半区的细节
#### 对结果的说明
$Z[1,1] = 34$:全局平均分量（最低频），反映整个输入矩阵的“均值”或基准亮度（理解为主基调）,这个数是输入矩阵所有数的加权平均
$Z[1,2] = -4$:行方向的低频“对比分量”，反映输入矩阵左半区与右半区均值的差。如果这数很大，说明左右两半有明显亮度差异。
$Z[1,3], Z[1,4] = -√2, -√2$：行方向更细的局部变化。反映左/右半区内部的“细节对比”，比如左上与左下，右上与右下的局部差异。
$Z[2,1] = -16$：列方向的低频“对比分量”。反映输入矩阵上半区与下半区均值的差。
$Z[3,1], Z[4,1] = -4√2, -4√2$：列方向更细的局部变化。分别反映上半区内部（如1-2行对比）和下半区内部（如3-4行对比）的细节变化。
其它$Z[i,j] = 0$：这些位置代表组合方向的更高频变化，在此例中输入是规则递增矩阵，所以高频分量为0，说明没有剧烈变化/噪声。
## 3D变换
3D变换就是在对每个块进行完2D变换后，再对体的第三维进行1D变换
### 输入矩阵体
矩阵体$X[i,j,k]$（其中$k=1,2$）由两个矩阵堆叠形成
### 对二维矩阵分别进行2D变换
得到结果：
$$
Y_1 =
\begin{bmatrix}
14 & 16 & 18 & 20 \\
-8 & -8 & -8 & -8 \\
-2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2} \\
-2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2}
\end{bmatrix}
$$
$$
Y_2 =
\begin{bmatrix}
18 & 20 & 22 & 24 \\
-8 & -8 & -8 & -8 \\
-2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2} \\
-2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2} & -2\sqrt{2}
\end{bmatrix}
$$
### 沿第三维k做1D Haar变换
对每个空间坐标$(i,j)$,取两个patch在该位置的2D变换系数，构成长度为2的向量$y_{i,j}=[Y_1(i,j),Y_2(i,j)]^T$
然后与2阶Haar矩阵进行点乘：
$$
H_2 = \frac{1}{\sqrt{2}}
\begin{bmatrix}
1 & 1 \\
1 & -1
\end{bmatrix}
$$
对 $y = [a,\, b]^T$，变换结果 $z = H_2 y$：

- $z_1 = \dfrac{a+b}{\sqrt{2}}$  （“组内平均/共性”）
- $z_2 = \dfrac{a-b}{\sqrt{2}}$  （“组内差异/噪声”）
用表格展示部分结果：

| (i,j)   | $Y_1(i,j)$ | $Y_2(i,j)$ | $z_1$ (组内均值) | $z_2$ (组内差异) |
|---------|------------|------------|------------------|------------------|
| (1,1)   | 14         | 18         | $16\sqrt{2}$     | $-2\sqrt{2}$     |
| (1,2)   | 16         | 20         | $18\sqrt{2}$     | $-2\sqrt{2}$     |
| (2,1)   | -8         | -8         | $-8\sqrt{2}$     | $0$              |
| (3,1)   | $-2\sqrt{2}$ | $-2\sqrt{2}$ | $-4$         | $0$              |
| (4,1)   | $-2\sqrt{2}$ | $-2\sqrt{2}$ | $-4$         | $0$              |
## 最终3D变换结果
得到的是一个 $4\times4\times2$ 的系数张量 $Z[i,j,k']$：
- $k'=1$：每个位置是组内均值（主成分/共性）

- $k'=2$：每个位置是组内差异（高频/噪声）
